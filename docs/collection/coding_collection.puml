@startuml FilingCollection Class Diagram
skinparam linetype ortho
skinparam classAttributeIconSize 0

package "Collection Core" {
    class Collection <<Facade>> {
        - index_db: IndexDB
        - registry_mgr: RegistryManager
        - storage: Storage
        - spec: CollectionSpec
        
        + add(filing, content)
        + get(filing_id): Filing
        + find(**filters): List[Filing]
        + rebuild_index()
        + verify_integrity()
        + migrate(new_storage)
    }
    
    class Filing <<Entity>> {
        + filing_id: str
        + source: str
        + source_id: str
        + checksum: str
        + metadata: dict
        - _storage: Storage
        - _content_cache: bytes
        
        + get_content(): bytes
        + verify_checksum(): bool
        + to_dict(): dict
    }
}

package "Index Layer (Cache)" {
    interface IndexDB {
        + index(filing)
        + search(**filters): List[dict]
        + get(filing_id): dict
        + clear()
        + rebuild(registry_mgr)
    }
    
    class SQLiteIndex {
        - conn: Connection
        + index(filing)
        + search(**filters)
        + rebuild(registry_mgr)
    }
}

package "Registry Layer (Source of Truth)" {
    class RegistryManager <<Memento>> {
        - storage: Storage
        - spec: CollectionSpec
        
        + register(filing, directory)
        + load_registry(directory): Registry
        + scan_all(): Iterator[Registry]
        + rebuild_from_payloads()
    }
    
    class Registry {
        + directory: str
        + filings: List[FilingMemento]
        + save()
        + load()
    }
    
    class FilingMemento {
        + filing_id: str
        + source: str
        + source_id: str
        + checksum: str
        + filename: str
        + created_at: datetime
    }
}

package "Storage Layer (Repository)" {
    interface Storage <<Repository>> {
        + save(path, content)
        + load(path): bytes
        + exists(path): bool
        + list(prefix): Iterator[str]
        + checksum(path): str
    }
    
    class LocalStorage {
        - base_dir: Path
    }
    
    class S3Storage {
        - bucket: str
        - prefix: str
    }
}

package "Spec Layer (Strategy)" {
    class CollectionSpec {
        + id_strategy: FilingIDStrategy
        + registry_strategy: RegistryPlacementStrategy
    }
    
    interface FilingIDStrategy {
        + generate_id(source, source_id, checksum): str
        + parse_id(filing_id): dict
    }
    
    interface RegistryPlacementStrategy {
        + get_registry_path(filing_metadata): str
        + scan_pattern(): str
    }
    
    class DateBasedPlacement {
        + get_registry_path()
    }
    
    class SourceBasedPlacement {
        + get_registry_path()
    }
}

package "Commands" {
    interface Command {
        + execute()
    }
    
    class RebuildCommand {
        + execute()
    }
    
    class VerifyCommand {
        + execute()
    }
    
    class MigrateCommand {
        + execute()
    }
}

' Relations
Collection *-- IndexDB
Collection *-- RegistryManager
Collection *-- Storage
Collection *-- CollectionSpec
Collection ..> Filing : creates
Collection ..> Command : uses

IndexDB <|.. SQLiteIndex
Storage <|.. LocalStorage
Storage <|.. S3Storage

RegistryManager o-- Storage
RegistryManager o-- CollectionSpec
RegistryManager ..> Registry : manages
Registry *-- FilingMemento

CollectionSpec o-- FilingIDStrategy
CollectionSpec o-- RegistryPlacementStrategy
RegistryPlacementStrategy <|.. DateBasedPlacement
RegistryPlacementStrategy <|.. SourceBasedPlacement

Command <|.. RebuildCommand
Command <|.. VerifyCommand
Command <|.. MigrateCommand

@enduml