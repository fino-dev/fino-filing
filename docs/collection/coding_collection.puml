@startuml FilingCollection Class Diagram
skinparam linetype ortho
skinparam classAttributeIconSize 0

package "Collection Core" {
    class Collection <<Facade>> {
        - index_db: IndexDB
        - storage: Storage
        
        + add(filing, content)
        + get(filing_id): Filing
        + find(**filters): List[Filing]
        + exists(filing_id): bool
        + rebuild_index()
        + verify_integrity()
        + migrate(new_storage)
    }
    
    class CoreFiling <<Entity>> {
        + filing_id: str
        + source: str
        + checksum: str
        - _storage: Storage
        - _content_cache: bytes
        
        + get_content(): bytes
        + verify_checksum(): bool
        + to_dict(): dict
    }
}

package "Index Layer" {
    class IndexDB {
        + index(filing)
        + search(**filters): List[dict]
        + get(filing_id): dict
        + clear()
        + rebuild(storage)
    }
}

package "Storage Layer (Repository)" {
    interface Storage <<Protocol>> {
        + save(filing_id, content, metadata): str
        + load(filing_id): bytes
        + exists(filing_id): bool
        + list_all(): Iterator[str]
        + get_path(filing_id): str
        + get_metadata(filing_id): dict
    }
    
    class FlatLocalStorage {
        - base_dir: Path
        - registry_path: Path
    }
}

' Relations
Collection *-- IndexDB
Collection *-- Storage
Collection ..> CoreFiling : creates

Storage <|.. FlatLocalStorage

@enduml
