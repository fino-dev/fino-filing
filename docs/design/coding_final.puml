@startuml fino-filing - Coding Level
title fino-filing - Class Diagram (Derived from Components Diagram)

skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

' top to bottom direction
left to right direction

package "Collection Boundary" {
    class Collection <public> {
        - root: Path
        - spec: Spec
        - index: IndexStore
        + add(file)
        + rescan()
        + find(**conditions)
    }

    package "Spec Layer" {
        interface Spec {
            + recover_semantic_core(entity)
            + compute_fingerprint(core)
        }
    class EdinetSpec
    class DefaultSpec
    }

    package "Index Layer (Cache)" {
        class IndexStore {
            + upsert(entity)
            + search(**conditions)
            + clear()
        }
        class SQLiteIndex
    }
}

package "Collector Boudary" {
    abstract BaseCollector {
    }
    package "Edinet Boundary" {
        class EdinetCollector <public> {
        }
        class EdinetClient <public> {}
        class EdinetQueryStrategy {
        }
        class EdinetResponseMapper {
        }
    }
    package "Edger Boundary" {
        class EdgerCollector <public> {
        }
        class EdgerClient <public> {}
        class EdgerQueryStrategy {
        }
        class EdgerResponseMapper {
        }
    }
}

' position
Collection -[hidden]d-> BaseCollector
' connection
Collection o-- BaseCollector

EdinetCollector --|> BaseCollector
EdgerCollector --|> BaseCollector

EdinetCollector o-- EdinetClient
EdgerCollector o-- EdgerClient

EdinetClient o-- EdinetQueryStrategy
EdinetClient o-- EdinetResponseMapper

EdgerClient o-- EdgerQueryStrategy
EdgerClient o-- EdgerResponseMapper


Collection o-- Spec
Collection o-- IndexStore

Spec <|.. EdinetSpec
Spec <|.. DefaultSpec


' package "Collection Boundary" {
'     class Collection <<public>> {
'         + add(filing, content)
'         + find(**filters)
'         + get(filing_id)
'         + list_all()
'         + export_catalog()
'     }
    
'     interface CatalogStore {
'         + index(metadata)
'         + search(**filters)
'         + get_metadata(filing_id)
'     }
    
'     class SQLiteCatalog {
'         - conn: Connection
'         + index(metadata)
'         + search(**filters)
'     }
    
'     class DuckDBCatalog {
'         - conn: Connection
'         + index(metadata)
'         + search(**filters)
'     }
    
'     interface Storage {
'         + save(path, content)
'         + load(path)
'         + exists(path)
'     }
    
'     class PartitionSpec {
'         - strategy: PartitionStrategy
'         + compute_path(metadata)
'     }
    
'     interface PartitionStrategy {
'         + generate_path(metadata)
'     }
    
'     class DatePartitionStrategy
'     class CompanyPartitionStrategy
'     class CustomPartitionStrategy
    
'     class Filing <<ValueObject>> {
'         + filing_id: str
'         + source: str
'         + metadata: dict
'         + get_content()
'         + to_xbrl()
'     }
' }

' Collection o-- CatalogStore
' Collection o-- Storage
' Collection o-- PartitionSpec
' CatalogStore <|.. SQLiteCatalog
' CatalogStore <|.. DuckDBCatalog
' PartitionSpec o-- PartitionStrategy
' PartitionStrategy <|.. DatePartitionStrategy
' PartitionStrategy <|.. CompanyPartitionStrategy
' PartitionStrategy <|.. CustomPartitionStrategy
' Collection ..> Filing : creates

package "Collection Core" {
    class FilingEntity {
        - file_path: Path
        - meta_path: Path
        + load_meta()
        + save_meta(meta)
        + semantic_core()
        + fingerprint()
    }
}


Collection *-- FilingEntity


IndexStore <|-- SQLiteIndex

@enduml

@enduml