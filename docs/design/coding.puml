@startuml fino-filing - Coding Level
title fino-filing - Class Diagram (Derived from Final Component Graph)

skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

' ========================
' Application Layer (Public API)
' ========================
package "application" {
  class Collection {
    - model: CollectionModel

    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
    + all() : list[Filing]
  }

  class Edinet {
    - adapter: EdinetAdapter
    - collection: Collection

    + sync_catalog() : None
    + search(**conditions) : list[Filing]
    + collect(**conditions) : CollectResult
  }
}

' ========================
' Domain Layer
' ========================
package "domain" {
  class Filing {
    + partition: list[str]
    + file_name: str
    + path: str
    + format_type: FormatType

    + open() : IO[bytes]
  }
  
  enum FormatType {
    XBRL
    PDF
    CSV
    ENGLISH
    ATTACHMENTS
  }
  Filing *-- FormatType

  class CollectionSpec {
    + partition: list[SpecField | CustomSpecField]
    + file_name: list[SpecField | CustomSpecField]

    + validate(): None  <doc_id必須・format_type pre-拡張子に必須>
    + generate_path(filing: FilingMetadata): str
  }

  enum SpecField {
    SEC_NUMBER
    DOC_ID
    EDINET_CODE
    SEC_CODE
    PERIOD_START
    PERIOD_END
    SUBMIT_DATETIME
    FILING_NAME
    DOCUMENT_TYPE
  }

  class CustomSpecField {
    + field_name: str
    + value: str

    + create(filing: FilingMetadata): str
  }
  CollectionSpec *-- SpecField
  CollectionSpec *-- CustomSpecField

  class FilingMetadata {
    + seq_number: str
    + doc_id: str
    + parent_doc_id: str
    + edinet_code: str
    + sec_code: str
    + period: Period
    + submit_datetime: datetime
    + filing_name: str
    + document_type: DocumentType
    + available_format_types: list[FormatType]
  }

  class Period {
    + start_date: str
    + end_date: str
  }
  FilingMetadata *-- Period

  class DocumentType {
    + code: DocumentTypeCode
    + type: DocumentTypeEnum
  }
  FilingMetadata *-- DocumentType

  class DocumentTypeCode {
    + value: str
  }
  DocumentType *-- DocumentTypeCode

  enum DocumentTypeEnum {
    ANNUAL_REPORT                   / 有価証券報告書
    AMENDED_ANNUAL_REPORT           / 訂正有価証券報告書
    SEMI_ANNUAL_REPORT              / 半期報告書
    AMENDED_SEMI_ANNUAL_REPORT      / 訂正半期報告書
    QUARTERLY_REPORT                / 四半期報告書
    AMENDED_QUARTERLY_REPORT        / 訂正四半期報告書
    MATERIAL_EVENT_REPORT           / 臨時報告書
    AMENDED_MATERIAL_EVENT_REPORT   / 訂正臨時報告書
    PARENT_COMPANY_REPORT           / 親会社等状況報告書
    AMENDED_PARENT_COMPANY_REPORT   / 訂正親会社等状況報告書
    SHARE_REPURCHASE_REPORT         / 自己株券買付状況報告書
    AMENDED_SHARE_REPURCHASE_REPORT / 訂正自己株券買付状況報告書
    OTHER                           / その他 マッピングしていないもの、できなかったもの
  }
  DocumentType *-- DocumentTypeEnum

  FilingMetadata *-- FormatType
}

' ========================
' Adapters (Interfaces)
' ========================
package "adapters.interfaces" {

  interface EdinetAdapter {
    + fetch_catalog() : list[dict]
    + fetch_document(document_id: str) : bytes
  }

  interface StorageAdapter {
    + save(document_id: str, content: bytes) : Path
    + open(path: Path) : IO
  }

  interface MetadataAdapter {
    + save(filing: Filing) : None
    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
  }
}

' ========================
' Adapters (Implementations)
' ========================
package "adapters.implementations" {

  class EdinetApiAdapter {
  }

  class LocalFileStorageAdapter {
  }

  class S3StorageAdapter {
  }

  class SQLiteMetadataAdapter {
  }

  class DynamoMetadataAdapter {
  }
}

' ========================
' Config
' ========================
package "config" {

  class EdinetConfig {
    + api_key: str
    + base_url: str
  }

  class StorageConfig {
    + type: str
    + root_path: Path
  }

  class MetadataConfig {
    + type: str
    + connection: str
  }
}

' ========================
' Relationships
' ========================

Edinet --> Collection
Edinet --> EdinetAdapter

Collection --> CollectionModel

CollectionModel --> StorageAdapter
CollectionModel --> MetadataAdapter

CollectResult --> Filing
CollectResult --> Collection

EdinetApiAdapter ..|> EdinetAdapter

LocalFileStorageAdapter ..|> StorageAdapter
S3StorageAdapter ..|> StorageAdapter

SQLiteMetadataAdapter ..|> MetadataAdapter
DynamoMetadataAdapter ..|> MetadataAdapter

MetadataAdapter --> Filing

Edinet --> EdinetConfig
CollectionModel --> StorageConfig
CollectionModel --> MetadataConfig

@enduml