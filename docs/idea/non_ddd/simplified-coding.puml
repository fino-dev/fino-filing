@startuml fino-filing - Simplified Class Diagram
title fino-filing - Simplified Class Diagram (DDD concepts removed)

skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

' ========================
' Services (Public API)
' ========================
package "services" {
  class EdinetService {
    - edinet_client: EdinetClient
    - filing_repo: FilingRepository
    
    + __init__(api_key: str, filing_repo: FilingRepository)
    + sync_catalog() : None
    + search(**conditions) : list[Filing]
    + collect(**conditions) : CollectResult
  }
  
  class CollectionService {
    - filing_repo: FilingRepository
    
    + __init__(filing_repo: FilingRepository)
    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
    + all() : list[Filing]
    + count(**conditions) : int
  }
}

' ========================
' Repositories (Data Access)
' ========================
package "repositories" {
  class FilingRepository {
    - storage: FileStorage
    - metadata_store: MetadataStore
    - spec: CollectionSpec
    
    + __init__(storage: FileStorage, metadata_store: MetadataStore, spec: CollectionSpec)
    + save(filing: Filing, content: bytes) : Filing
    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
    + delete(document_id: str) : None
    + count(**conditions) : int
  }
  
  class EdinetClient {
    - api_key: str
    - base_url: str
    - session: httpx.Client
    
    + __init__(api_key: str, base_url: str = DEFAULT_URL)
    + fetch_catalog(date: date = None) : list[dict]
    + fetch_document(document_id: str, format_type: FormatType) : bytes
    + fetch_metadata(document_id: str) : dict
  }
  
  class FileStorage {
    - root_path: Path
    - storage_type: str
    
    + __init__(root_path: Path, storage_type: str = "local")
    + save(path: Path, content: bytes) : Path
    + load(path: Path) : bytes
    + exists(path: Path) : bool
    + delete(path: Path) : None
  }
  
  class MetadataStore {
    - db_path: Path
    - connection: Connection
    
    + __init__(db_path: Path)
    + save(filing: Filing) : None
    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
    + delete(document_id: str) : None
    + count(**conditions) : int
  }
}

' ========================
' Models (Data Structures)
' ========================
package "models" {
  class Filing {
    + document_id: str
    + partition: list[str]
    + file_name: str
    + path: Path
    + format_type: FormatType
    + metadata: FilingMetadata
    
    + open() : IO[bytes]
  }
  
  class FilingMetadata {
    + seq_number: str
    + doc_id: str
    + parent_doc_id: str | None
    + edinet_code: str
    + sec_code: str | None
    + period: Period
    + submit_datetime: datetime
    + filing_name: str
    + document_type: DocumentType
    + available_format_types: list[FormatType]
  }
  
  class Period {
    + start_date: date
    + end_date: date
  }
  
  class DocumentType {
    + code: str
    + type: DocumentTypeEnum
    + label_ja: str
  }
  
  enum DocumentTypeEnum {
    ANNUAL_REPORT
    QUARTERLY_REPORT
    SEMI_ANNUAL_REPORT
    MATERIAL_EVENT_REPORT
    PARENT_COMPANY_REPORT
    SHARE_REPURCHASE_REPORT
    OTHER
  }
  
  enum FormatType {
    XBRL
    PDF
    CSV
    ENGLISH
    ATTACHMENTS
  }
  
  class CollectionSpec {
    + partition: list[SpecField | CustomSpecField]
    + file_name: list[SpecField | CustomSpecField]
    
    + generate_path(metadata: FilingMetadata) : Path
    + validate() : None
  }
  
  enum SpecField {
    SEC_NUMBER
    DOC_ID
    EDINET_CODE
    SEC_CODE
    PERIOD_START
    PERIOD_END
    SUBMIT_DATETIME
    FILING_NAME
    DOCUMENT_TYPE
  }
  
  class CustomSpecField {
    + field_name: str
    + generator: Callable
    
    + render(metadata: FilingMetadata) : str
  }
  
  class CollectResult {
    + collected: list[Filing]
    + failed: list[tuple[str, Exception]]
    + total: int
    + success_count: int
    + failure_count: int
  }
}

' ========================
' Configuration
' ========================
package "config" {
  class Config {
    + edinet_api_key: str
    + storage_root_path: Path
    + storage_type: str
    + metadata_db_path: Path
    
    + from_env() : Config
    + from_file(path: Path) : Config
  }
}

' ========================
' Relationships
' ========================

' Services dependencies
EdinetService --> EdinetClient
EdinetService --> FilingRepository
CollectionService --> FilingRepository

' Repository dependencies
FilingRepository --> FileStorage
FilingRepository --> MetadataStore
FilingRepository --> CollectionSpec

' Models relationships
Filing *-- FilingMetadata
Filing *-- FormatType
FilingMetadata *-- Period
FilingMetadata *-- DocumentType
FilingMetadata *-- FormatType
DocumentType *-- DocumentTypeEnum
CollectionSpec *-- SpecField
CollectionSpec *-- CustomSpecField
CollectResult --> Filing

' Services use models
EdinetService ..> Filing
EdinetService ..> CollectResult
CollectionService ..> Filing

' Repositories use models
FilingRepository ..> Filing
EdinetClient ..> FilingMetadata

' Config
EdinetService ..> Config
FilingRepository ..> Config

note right of EdinetService
  **公開API**
  - ユーザーが直接利用
  - EDINET連携の窓口
  - sync/search/collect
end note

note right of FilingRepository
  **データアクセス**
  - ストレージとDBの統合管理
  - 具体的な実装クラス
  - インターフェース不要
end note

note right of Filing
  **データモデル**
  - Pydantic BaseModel
  - イミュータブル推奨
  - バリデーション付き
end note

note bottom of services
  **シンプルな2層構造**
  Services (ビジネスロジック)
  → Repositories (データアクセス)
  → Models (データ構造)
  
  インターフェースやAdapterは不要
end note

@enduml
