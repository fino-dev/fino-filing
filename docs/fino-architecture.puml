@startuml fino - Redesigned Architecture (OSS Best Practices)
title fino - Library Architecture (Pydantic/Typer/FastAPI/pytest Inspired)

skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam note {
  BackgroundColor #FFFFCC
  BorderColor #999999
}

' ========================
' Layer 1: Public API (fino/__init__.py)
' ========================
package "Public API" <<Cloud>> #E8F5E9 {
  note as N1
    **公開API** (Typer/Pydanticスタイル)
    - fino.__init__.pyでエクスポート
    - ユーザーが直接使用するインターフェース
    - セマンティックバージョニング保証
  end note
  
  class Edinet {
    + sync_catalog() : None
    + search(**conditions) : list[Filing]
    + collect(**conditions) : CollectResult
    + get(document_id: str) : Filing
    --
    型ヒントベースのAPI
    デフォルト設定で即座に動作
  }
  
  class Collection {
    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
    + all() : list[Filing]
    + count(**conditions) : int
    --
    シンプルなクエリインターフェース
  }
  
  class CollectionSpecBuilder {
    + with_partition(*fields) : Self
    + with_file_name(*fields) : Self
    + with_custom_field(name, value) : Self
    + build() : CollectionSpec
    --
    Builderパターン(Typerスタイル)
    メソッドチェーンで段階的構築
  }
}

' ========================
' Layer 2: Domain Models (fino.models, fino.types)
' ========================
package "Domain Models" <<Rectangle>> #FFF3E0 {
  note as N2
    **ドメインモデル** (Pydanticベース)
    - 値オブジェクト(イミュータブル)
    - エンティティ(識別子あり)
    - 型安全性、バリデーション
  end note
  
  class Filing <<ValueObject>> {
    + document_id: str
    + partition: tuple[str, ...]
    + file_name: str
    + path: Path
    + format_type: FormatType
    + metadata: FilingMetadata
    --
    + open() : IO[bytes]
    + validate() : None
    --
    frozen=True (イミュータブル)
  }
  
  class FilingMetadata <<Entity>> {
    + seq_number: str
    + doc_id: str  <<PK>>
    + parent_doc_id: str | None
    + edinet_code: str
    + sec_code: str | None
    + period: Period
    + submit_datetime: datetime
    + filing_name: str
    + document_type: DocumentType
    + available_format_types: list[FormatType]
    --
    + validate() : None
    --
    Pydantic BaseModel
    自動バリデーション
  }
  
  class Period <<ValueObject>> {
    + start_date: date
    + end_date: date
    --
    + duration_days() : int
    + validate() : None
    --
    frozen=True
    start_date <= end_date
  }
  
  class DocumentType <<ValueObject>> {
    + code: str
    + type: DocumentTypeEnum
    + label_ja: str
    --
    + validate() : None
    + from_code(code: str) : DocumentType
    --
    Factoryメソッド
  }
  
  enum DocumentTypeEnum {
    ANNUAL_REPORT
    QUARTERLY_REPORT
    SEMI_ANNUAL_REPORT
    MATERIAL_EVENT_REPORT
    PARENT_COMPANY_REPORT
    SHARE_REPURCHASE_REPORT
    OTHER
  }
  
  enum FormatType {
    XBRL
    PDF
    CSV
    ENGLISH
    ATTACHMENTS
  }
  
  class CollectionSpec <<ValueObject>> {
    + partition: tuple[SpecField | CustomSpecField, ...]
    + file_name: tuple[SpecField | CustomSpecField, ...]
    --
    + validate() : None
    + generate_path(metadata: FilingMetadata) : Path
    --
    doc_idとformat_typeの必須チェック
  }
  
  enum SpecField {
    SEC_NUMBER
    DOC_ID
    EDINET_CODE
    SEC_CODE
    PERIOD_START
    PERIOD_END
    SUBMIT_DATETIME
    FILING_NAME
    DOCUMENT_TYPE
  }
  
  class CustomSpecField <<ValueObject>> {
    + field_name: str
    + value: str
    --
    + render(metadata: FilingMetadata) : str
    --
    カスタムフィールド
  }
  
  class CollectResult {
    + collected: list[Filing]
    + failed: list[tuple[str, Exception]]
    + total: int
    + success_count: int
    + failure_count: int
    --
    + raise_on_failure() : None
  }
}

' ========================
' Layer 3: Plugin Interfaces (fino.plugins)
' ========================
package "Plugin Interfaces" <<Frame>> #E3F2FD {
  note as N3
    **プラグインシステム** (pytestスタイル)
    - 拡張可能なバックエンド
    - エントリーポイント登録
    - 実行時プラグイン検出
  end note
  
  interface StoragePlugin {
    + save(path: Path, content: bytes) : Path
    + load(path: Path) : bytes
    + exists(path: Path) : bool
    + delete(path: Path) : None
    + list(prefix: Path) : list[Path]
    --
    {abstract}
  }
  
  interface MetadataPlugin {
    + save(filing: Filing) : None
    + save_batch(filings: list[Filing]) : None
    + search(**conditions) : list[Filing]
    + get(document_id: str) : Filing
    + count(**conditions) : int
    + delete(document_id: str) : None
    --
    {abstract}
  }
  
  interface ValidatorPlugin {
    + validate(filing: FilingMetadata) : None
    + validate_batch(filings: list[FilingMetadata]) : None
    --
    {abstract}
    カスタムバリデーションルール
  }
  
  interface TransformerPlugin {
    + transform(metadata: dict) : FilingMetadata
    --
    {abstract}
    外部データの変換
  }
  
  class PluginRegistry {
    - _storage_plugins: dict[str, type[StoragePlugin]]
    - _metadata_plugins: dict[str, type[MetadataPlugin]]
    --
    + register_storage(name: str, plugin: type) : None
    + register_metadata(name: str, plugin: type) : None
    + get_storage(name: str) : type[StoragePlugin]
    + get_metadata(name: str) : type[MetadataPlugin]
    + discover_plugins() : None
    --
    pytestスタイルのプラグイン管理
  }
}

' ========================
' Layer 4: Internal Implementation (fino._internal)
' ========================
package "Internal Implementation\n(fino._internal)" <<Rectangle>> #ECEFF1 {
  note as N4
    **内部実装** (Pydanticスタイル)
    - 非公開API(_プレフィックス)
    - リファクタリング自由
    - 後方互換性の制約なし
  end note
  
  package "_internal.adapters" {
    class EdinetApiAdapter {
      - config: EdinetConfig
      - session: httpx.Client
      --
      + fetch_catalog(date: date) : list[dict]
      + fetch_document(doc_id: str) : bytes
      + fetch_metadata(doc_id: str) : dict
      --
      EDINET API v2統合
    }
  }
  
  package "_internal.factories" {
    class FilingFactory {
      + from_metadata(metadata: FilingMetadata, spec: CollectionSpec) : Filing
      + from_dict(data: dict) : Filing
      + batch_from_catalog(catalog: list[dict]) : list[FilingMetadata]
      --
      Factoryパターン(Pydanticスタイル)
    }
    
    class EdinetClientFactory {
      + create(config: EdinetConfig | None) : Edinet
      + from_env() : Edinet
      --
      設定からクライアント生成
    }
  }
  
  package "_internal.validators" {
    class FilingValidator {
      + validate_metadata(metadata: FilingMetadata) : None
      + validate_spec(spec: CollectionSpec) : None
      + validate_filing(filing: Filing) : None
      --
      バリデーションロジック
    }
  }
  
  package "_internal.collectors" {
    class CollectionManager {
      - spec: CollectionSpec
      - storage: StoragePlugin
      - metadata: MetadataPlugin
      --
      + collect_filing(metadata: FilingMetadata, content: bytes) : Filing
      + collect_batch(items: list[tuple[FilingMetadata, bytes]]) : list[Filing]
      --
      コレクションオーケストレーション
    }
  }
  
  package "_internal.strategies" {
    interface StorageStrategy {
      + save(path: Path, content: bytes) : Path
      + load(path: Path) : bytes
      --
      Strategyパターン(FastAPIスタイル)
    }
    
    class LocalFileStorage {
      - root_path: Path
    }
    
    class S3Storage {
      - bucket: str
      - prefix: str
      - client: boto3.Client
    }
    
    class GCSStorage {
      - bucket: str
      - prefix: str
    }
    
    interface MetadataStrategy {
      + save(filing: Filing) : None
      + search(**conditions) : list[Filing]
    }
    
    class SQLiteMetadata {
      - db_path: Path
      - connection: sqlite3.Connection
    }
    
    class PostgreSQLMetadata {
      - connection_url: str
      - engine: sqlalchemy.Engine
    }
    
    class DynamoDBMetadata {
      - table_name: str
      - client: boto3.Client
    }
  }
}

' ========================
' Layer 5: Configuration & Exceptions
' ========================
package "Configuration & Exceptions" <<Rectangle>> #F3E5F5 {
  class EdinetConfig {
    + api_key: str | None
    + base_url: str
    + timeout: int
    + retry_count: int
    --
    + from_env() : EdinetConfig
    + validate() : None
    --
    Pydantic BaseSettings
  }
  
  class StorageConfig {
    + type: str
    + options: dict[str, Any]
    --
    + validate() : None
  }
  
  class MetadataConfig {
    + type: str
    + options: dict[str, Any]
    --
    + validate() : None
  }
  
  class FinoConfig {
    + edinet: EdinetConfig
    + storage: StorageConfig
    + metadata: MetadataConfig
    --
    + from_file(path: Path) : FinoConfig
    + from_env() : FinoConfig
    --
    設定の一元管理
  }
  
  class FinoException {
    + message: str
    + details: dict[str, Any]
  }
  
  class ValidationError extends FinoException
  class APIError extends FinoException
  class StorageError extends FinoException
  class MetadataError extends FinoException
  class PluginError extends FinoException
}

' ========================
' Relationships - Public API Layer
' ========================
Edinet --> Collection : uses
Edinet --> EdinetClientFactory : created by
Collection --> Filing : returns
Collection --> CollectionManager : delegates to

CollectionSpecBuilder ..> CollectionSpec : builds

' ========================
' Relationships - Domain Models
' ========================
Filing *-- FilingMetadata : contains
Filing *-- FormatType : has
FilingMetadata *-- Period : has
FilingMetadata *-- DocumentType : has
FilingMetadata *-- FormatType : available formats
DocumentType *-- DocumentTypeEnum : type
CollectionSpec *-- SpecField : uses
CollectionSpec *-- CustomSpecField : uses
CollectResult --> Filing : contains

' ========================
' Relationships - Plugins
' ========================
StoragePlugin <|.. LocalFileStorage : implements
StoragePlugin <|.. S3Storage : implements
StoragePlugin <|.. GCSStorage : implements

MetadataPlugin <|.. SQLiteMetadata : implements
MetadataPlugin <|.. PostgreSQLMetadata : implements
MetadataPlugin <|.. DynamoDBMetadata : implements

LocalFileStorage ..|> StorageStrategy
S3Storage ..|> StorageStrategy
GCSStorage ..|> StorageStrategy

SQLiteMetadata ..|> MetadataStrategy
PostgreSQLMetadata ..|> MetadataStrategy
DynamoDBMetadata ..|> MetadataStrategy

PluginRegistry --> StoragePlugin : manages
PluginRegistry --> MetadataPlugin : manages
PluginRegistry --> ValidatorPlugin : manages
PluginRegistry --> TransformerPlugin : manages

' ========================
' Relationships - Internal Implementation
' ========================
EdinetClientFactory ..> Edinet : creates
EdinetClientFactory --> EdinetConfig : uses

FilingFactory ..> Filing : creates
FilingFactory --> FilingMetadata : uses
FilingFactory --> CollectionSpec : uses

CollectionManager --> StorageStrategy : uses
CollectionManager --> MetadataStrategy : uses
CollectionManager --> CollectionSpec : uses
CollectionManager --> FilingFactory : uses
CollectionManager --> FilingValidator : uses

Edinet --> EdinetApiAdapter : uses
Edinet --> CollectionManager : uses

FilingValidator --> FilingMetadata : validates
FilingValidator --> CollectionSpec : validates

' ========================
' Relationships - Configuration
' ========================
FinoConfig *-- EdinetConfig
FinoConfig *-- StorageConfig
FinoConfig *-- MetadataConfig

Edinet --> FinoConfig : configured by
EdinetApiAdapter --> EdinetConfig : uses

' ========================
' Design Patterns Legend
' ========================
note bottom of FilingFactory
  **Factory Pattern**
  オブジェクト生成の一元化
  (Pydantic/Typerスタイル)
end note

note bottom of CollectionSpecBuilder
  **Builder Pattern**
  複雑な設定の段階的構築
  (Typerスタイル)
end note

note bottom of StorageStrategy
  **Strategy Pattern**
  ストレージバックエンドの切り替え
  (FastAPIスタイル)
end note

note bottom of PluginRegistry
  **Plugin Pattern**
  拡張可能なアーキテクチャ
  (pytestスタイル)
end note

note bottom of StoragePlugin
  **Adapter Pattern**
  外部システムの抽象化
  (FastAPI/Pydanticスタイル)
end note

' ========================
' Architecture Notes
' ========================
note right of N1
  **依存性の方向**
  Public API → Domain Models
  → Plugin IF → Internal Impl
  
  内部実装は公開APIに依存しない
  (Pydanticスタイル)
end note

legend right
  **fino Library Architecture**
  
  **設計原則** (OSS Best Practices)
  1. 公開APIと内部実装の明確な分離 (Pydantic)
  2. 型安全性とバリデーション (Pydantic)
  3. シンプルで直感的なAPI (Typer)
  4. プラガブルな拡張性 (pytest)
  5. 依存性注入とStrategy (FastAPI)
  
  **パッケージ構造**
  fino/
  ├── __init__.py      (公開API)
  ├── models.py        (ドメインモデル)
  ├── types.py         (型定義)
  ├── plugins/         (プラグインIF)
  └── _internal/       (内部実装)
      ├── adapters/
      ├── factories/
      ├── validators/
      ├── collectors/
      └── strategies/
endlegend

@enduml
